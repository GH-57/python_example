<!DOCTYPE html> 
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê·¸ì±…ì‚¬ ë²Œê¸ˆ ê³„ì‚°ê¸° (ìˆ˜ì •ë³¸)</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Malgun Gothic', sans-serif;
      background: linear-gradient(to bottom, #eef2ff, #ffffff);
      padding: 30px;
      max-width: 900px;
      margin: auto;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #333; margin-bottom: 20px; }
    .selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 10px;
    }
    select, button {
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .person-card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background: #f9f9ff;
    }
    .checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }
    .fine-amount {
      font-weight: bold;
      margin-top: 10px;
    }
    #accumulated-fines {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
      color: #555;
      white-space: pre-line; /* ì¤„ë°”ê¿ˆ ë°˜ì˜ */
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š ê·¸ì±…ì‚¬ ë²Œê¸ˆ ê³„ì‚°ê¸°</h1>
    <div class="selector">
      <select id="week-select" onchange="changeWeekOrDay()">
        <option value="1">1ì£¼ì°¨</option>
        <option value="2">2ì£¼ì°¨</option>
        <option value="3">3ì£¼ì°¨</option>
        <option value="4">4ì£¼ì°¨</option>
        <option value="5">5ì£¼ì°¨</option>
        <option value="6">6ì£¼ì°¨</option>
        <option value="7">7ì£¼ì°¨</option>
        <option value="8">8ì£¼ì°¨</option>
        <option value="9">9ì£¼ì°¨</option>
      </select>
      <select id="day-select" onchange="changeWeekOrDay()">
        <option value="0">ì›”</option>
        <option value="1">í™”</option>
        <option value="2">ìˆ˜</option>
        <option value="3">ëª©</option>
        <option value="4">ê¸ˆ</option>
        <option value="5">í† </option>
      </select>
      <button onclick="saveDataToFirebase()">ğŸ’¾ ì €ì¥</button>
    </div>

    <!-- ëˆ„ì  ë²Œê¸ˆ í‘œì‹œ -->
    <div id="accumulated-fines">
      ëˆ„ì  ë²Œê¸ˆ: -
    </div>

    <div id="people-container"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDTAD9cvkVmtiRj_yFj39x0D2Zjcb6CYZU",
      authDomain: "thebookpeople.firebaseapp.com",
      projectId: "thebookpeople"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const people = ['ìœ¤í¬ì¤€', 'ê¹€í•˜ì†œ', 'ê¹€ì˜ì§„', 'ê¹€í¬ê²½', 'ê¸ˆì˜ˆì€', 'ë°°ê·¼í˜¸', 'ì†¡ì§€í˜œ', 'ì„ê±´'];
    let currentWeek = 1;
    let currentDay = 0;
    let dailyData = {};

    function initializeDailyData() {
      for (let week = 1; week <= 9; week++) {
        dailyData[week] = {};
        for (let day = 0; day < 6; day++) {
          dailyData[week][day] = {};
          people.forEach((_, i) => {
            dailyData[week][day][i] = { task1: false, task2: false, task3: false };
          });
        }
      }
    }

    function initializePeople() {
      const container = document.getElementById('people-container');
      container.innerHTML = '';
      people.forEach((name, i) => {
        const div = document.createElement('div');
        div.className = 'person-card';
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          <div class="checkboxes">
            <label><input type="checkbox" id="task1_${i}" onchange="saveAndRecalc(${i})"> ë³¸ë¬¸ë¬µìƒ</label>
            <label><input type="checkbox" id="task2_${i}" onchange="saveAndRecalc(${i})"> í†µë…</label>
            <label><input type="checkbox" id="task3_${i}" onchange="saveAndRecalc(${i})"> êµë¦¬ë¬¸ë‹µ</label>
          </div>
          <div class="fine-amount" id="fine_${i}">ë²Œê¸ˆ: 0ì›</div>
        `;
        container.appendChild(div);
      });
    }

    function saveAndRecalc(i) {
      const data = dailyData[currentWeek][currentDay][i] = {
        task1: document.getElementById(`task1_${i}`).checked,
        task2: document.getElementById(`task2_${i}`).checked,
        task3: document.getElementById(`task3_${i}`).checked
      };
      const missed = [data.task1, data.task2, data.task3].filter(x => !x).length;
      const fine = missed === 1 ? 0 : missed === 2 ? 500 : missed === 3 ? 1000 : 0;
      document.getElementById(`fine_${i}`).textContent = `ë²Œê¸ˆ: ${fine.toLocaleString()}ì›`;

      updateAccumulatedFines();
    }

    function changeWeekOrDay() {
      currentWeek = parseInt(document.getElementById('week-select').value);
      currentDay = parseInt(document.getElementById('day-select').value);
      people.forEach((_, i) => {
        const data = dailyData[currentWeek][currentDay][i];
        document.getElementById(`task1_${i}`).checked = data.task1;
        document.getElementById(`task2_${i}`).checked = data.task2;
        document.getElementById(`task3_${i}`).checked = data.task3;
        saveAndRecalc(i);
      });

      updateAccumulatedFines();
    }

    function saveDataToFirebase() {
      db.collection('ë²Œê¸ˆë°ì´í„°').doc('dailyData').set(dailyData)
        .then(() => alert('ì €ì¥ ì™„ë£Œ'))
        .catch(err => alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message));
    }

    function loadDataFromFirebase() {
      db.collection('ë²Œê¸ˆë°ì´í„°').doc('dailyData').get()
        .then(doc => {
          if (doc.exists) {
            dailyData = doc.data();
          } else {
            initializeDailyData();
          }
          initializePeople();
          changeWeekOrDay();
        })
        .catch(() => {
          initializeDailyData();
          initializePeople();
          changeWeekOrDay();
        });
    }

    function calculateAccumulatedFines(week) {
      const daysCount = 6;

      const today = new Date();
      let currentRealDay = today.getDay() - 1; // ì›”=0, ..., í† =5
      if (currentRealDay < 0) currentRealDay = 0; // ì¼ìš”ì¼ì´ë©´ 0ìœ¼ë¡œ ë§ì¶¤

      const currentRealWeek = week; // ê¸°ì¤€ì€ ì„ íƒí•œ ì£¼ì°¨(í•„ìš”í•˜ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²ƒë„ ê°€ëŠ¥)

      const accumulatedFines = [];

      for (let i = 0; i < people.length; i++) {
        let totalFine = 0;
        for (let day = 0; day < daysCount; day++) {
          // ì˜¤ëŠ˜ ê¸°ì¤€ìœ¼ë¡œ ì•„ì§ ì•ˆì˜¨ ìš”ì¼ì€ ëˆ„ì  ë²Œê¸ˆ ê³„ì‚°ì—ì„œ ì œì™¸
          if (week === currentRealWeek && day > currentRealDay) continue;

          const data = dailyData[week][day][i];
          if (!data) continue;

          const missed = [data.task1, data.task2, data.task3].filter(x => !x).length;
          const fine = missed === 1 ? 0 : missed === 2 ? 500 : missed === 3 ? 1000 : 0;
          totalFine += fine;
        }
        accumulatedFines[i] = totalFine;
      }

      return accumulatedFines;
    }

    function updateAccumulatedFines() {
      const fines = calculateAccumulatedFines(currentWeek);
      const container = document.getElementById('accumulated-fines');

      let text = 'ëˆ„ì  ë²Œê¸ˆ:\n';
      people.forEach((name, i) => {
        text += `${name}: ${fines[i].toLocaleString()}ì›\n`;
      });

      container.textContent = text;
    }

    window.onload = function() {
      initializeDailyData();
      loadDataFromFirebase();
    };
  </script>
</body>
</html>
